---
- name: Deploy Caddy reverse proxy for CoreDNS UI
  hosts: all
  become: yes
  vars:
    # deploy_user and domain are passed via --extra-vars
    home_path: "/home/{{ deploy_user }}"
    app_path: "{{ home_path }}/coredns_ui"

  tasks:
    # ----------------------------------------------------------------
    # 1. Install Caddy and set up directories
    # ----------------------------------------------------------------
    - name: Install Caddy and set up directories
      ansible.builtin.shell: |
        apt-get update -qq
        DEBIAN_FRONTEND=noninteractive apt-get install -y -qq debian-keyring debian-archive-keyring apt-transport-https curl
        if [ ! -f /usr/share/keyrings/caddy-stable-archive-keyring.gpg ]; then
          curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/caddy-stable-archive-keyring.gpg] https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version main" > /etc/apt/sources.list.d/caddy-stable.list
          apt-get update -qq
        fi
        apt-get install -y -qq caddy
        mkdir -p /var/log/caddy /etc/caddy/conf.d
        chown caddy:caddy /var/log/caddy
      changed_when: true

    # ----------------------------------------------------------------
    # 2. Detect Puma port from deployed config
    # ----------------------------------------------------------------
    - name: Detect Puma port from config
      ansible.builtin.shell: grep '^[[:space:]]*port ' {{ app_path }}/config/puma.rb | grep -oP '\{\s*\K[0-9]+'
      register: detected_port
      changed_when: false

    - name: Verify Puma port was detected
      ansible.builtin.fail:
        msg: "Could not detect Puma port from {{ app_path }}/config/puma.rb"
      when: detected_port.stdout == ""

    # ----------------------------------------------------------------
    # 3. Deploy Caddy configuration
    # ----------------------------------------------------------------
    - name: Deploy main Caddyfile with global log and conf.d import
      ansible.builtin.copy:
        dest: /etc/caddy/Caddyfile
        content: |
          {
              log {
                  output file /var/log/caddy/caddy.log {
                      roll_size 100MiB
                      roll_keep 5
                      roll_keep_for 720h
                  }
                  level INFO
              }
          }

          import /etc/caddy/conf.d/*.caddy
        owner: root
        group: root
        mode: "0644"
      notify: Reload Caddy

    - name: Deploy Caddy site config for {{ domain }}
      ansible.builtin.copy:
        dest: "/etc/caddy/conf.d/{{ domain }}.caddy"
        content: |
          {{ domain }} {
              reverse_proxy localhost:{{ detected_port.stdout }}

              log {
                  output file /var/log/caddy/{{ domain }}.access.log {
                      roll_size 100MiB
                      roll_keep 5
                      roll_keep_for 720h
                  }
                  format json
                  level DEBUG
              }
          }
        owner: root
        group: root
        mode: "0644"
      notify: Reload Caddy

    - name: Deploy logrotate config for Caddy
      ansible.builtin.copy:
        dest: /etc/logrotate.d/caddy
        content: |
          /var/log/caddy/*.log {
              daily
              missingok
              rotate 14
              compress
              delaycompress
              notifempty
              create 0644 caddy caddy
              sharedscripts
              postrotate
                  systemctl reload caddy > /dev/null 2>&1 || true
              endscript
          }
        owner: root
        group: root
        mode: "0644"

    # ----------------------------------------------------------------
    # 4. Firewall and service
    # ----------------------------------------------------------------
    - name: Allow HTTP (port 80) for Let's Encrypt ACME challenge
      community.general.ufw:
        rule: allow
        port: "80"
        proto: tcp

    - name: Enable and start Caddy
      ansible.builtin.systemd:
        name: caddy
        enabled: yes
        state: started
        daemon_reload: yes

  handlers:
    - name: Reload Caddy
      ansible.builtin.systemd:
        name: caddy
        state: reloaded
